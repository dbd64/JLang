language: java
jdk:
  - oraclejdk8

cache:
  directories:
    - /usr/local/Homebrew

env: BOEHM_VERSION=7.6.4

addons:
  homebrew:
    packages:
    - llvm@5
    - git-lfs
    - ant@1.9
    - libatomic_ops
  apt:
    sources:
      - llvm-toolchain-trusty-5.0
      - llvm-toolchain-trusty-6.0
      - sourceline: 'ppa:ubuntu-toolchain-r/test'
      - sourceline: 'ppa:git-core/ppa'
    packages:
      - clang-5.0 llvm-5.0 llvm-5.0-dev libllvm5.0 libstdc++6 libclang-common-5.0-dev libclang1-5.0 llvm-5.0-runtime libllvm5.0 libstdc++6 libllvm5.0
      - libatomic-ops-dev

matrix:
  include:
    - os: osx
      compiler: clang
      osx_image: xcode9.3

    - os: linux
      dist: precise

install: 
  - |
    if [[ "${TRAVIS_OS_NAME}" == "linux" ]]; then
      echo LINUX

      # Install git lfs
      curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
      sudo apt-get install git-lfs

      # Install ant 1.9
      wget https://www-us.apache.org/dist//ant/binaries/apache-ant-1.9.14-bin.tar.gz
      sudo tar -xzf apache-ant-1.9.14-bin.tar.gz  -C /usr/local
      sudo ln -s /usr/local/apache-ant-1.9.7/ /usr/local/ant
      export ANT_HOME=/usr/local/ant
      export PATH=${ANT_HOME}/bin:${PATH}
    else
      /usr/libexec/java_home -V

      # Install llvm 5
      export PATH="/usr/local/opt/llvm@5/bin:$PATH"

      # Install ant 1.9 
      export PATH="/usr/local/opt/ant@1.9/bin:$PATH"
    fi
  
  # Install Boehm GC
  - |
    if [[ "${TRAVIS_OS_NAME}" == "linux" ]]; then
      wget http://www.hboehm.info/gc/gc_source/gc-${BOEHM_VERSION}.tar.gz
      sudo tar -xzf gc-${BOEHM_VERSION}.tar.gz
    else
      curl -OL http://www.hboehm.info/gc/gc_source/gc-${BOEHM_VERSION}.tar.gz
      sudo tar -xzf gc-${BOEHM_VERSION}.tar.gz
    fi

  - sudo tar -xzf gc-${BOEHM_VERSION}.tar.gz
  - cd gc-${BOEHM_VERSION}
  - sudo ./configure 
  - sudo make 
  - sudo make install

before_script:
  - cd ${TRAVIS_BUILD_DIR}
  - git lfs pull
  - |
    if [[ "${TRAVIS_OS_NAME}" == "linux" ]]; then
      export JDK7=/usr/lib/jvm/java-7-oracle
      export CLANG_VERSION=5.0
    else
      /usr/libexec/java_home -V
      export JAVA_HOME=$(/usr/libexec/java_home -v 1.8)
      export JDK7=$(/usr/libexec/java_home -v 1.8)
    fi

script:
  - |
    if [[ "${TRAVIS_OS_NAME}" == "linux" ]]; then
      make
      make tests
    else
      make
    fi